/**
 * WZ encryption constants.
 * Ported from MapleLib/WzLib/WzAESConstant.cs + MapleCryptoLib/MapleCryptoConstants.cs
 */

// IV used to create the WzKey for GMS (old)
export const WZ_GMSIV = new Uint8Array([0x4D, 0x23, 0xC7, 0x2B]);

// IV used to create the WzKey for MSEA / KMS / latest GMS
export const WZ_MSEAIV = new Uint8Array([0xB9, 0x7D, 0x63, 0xE9]);

// IV for BMS / Classic (no encryption)
export const WZ_BMSIV = new Uint8Array([0x00, 0x00, 0x00, 0x00]);

// Constant used in WZ offset encryption
export const WZ_OFFSET_CONSTANT = 0x581C3F6D;

/**
 * Default AES UserKey used by MapleStory (128 bytes → trimmed to 32 bytes for AES-256)
 */
export const MAPLESTORY_USERKEY_DEFAULT = new Uint8Array([
    0x13, 0x00, 0x00, 0x00, 0x52, 0x00, 0x00, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x5B, 0x00, 0x00, 0x00,
    0x08, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00,
    0xB4, 0x00, 0x00, 0x00, 0x4B, 0x00, 0x00, 0x00, 0x35, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
    0x1B, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x5F, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x0F, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x1B, 0x00, 0x00, 0x00,
    0x33, 0x00, 0x00, 0x00, 0x55, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
    0x52, 0x00, 0x00, 0x00, 0xDE, 0x00, 0x00, 0x00, 0xC7, 0x00, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00,
]);

/**
 * Trim the 128-byte UserKey to 32 bytes for AES-256
 * Picks every 16th byte (i.e. the first byte of each 4-byte DWORD)
 */
export function getTrimmedUserKey(userKey) {
    const key = new Uint8Array(32);
    for (let i = 0; i < 128; i += 16) {
        key[i / 4] = userKey[i];
    }
    return key;
}

/**
 * WzMapleVersion enum — determines which IV to use
 */
export const WzMapleVersion = {
    GMS: 'GMS',
    EMS: 'EMS',       // uses MSEA IV
    BMS: 'BMS',       // no encryption
    CLASSIC: 'CLASSIC', // same as BMS
};

/**
 * Get IV bytes for a given WzMapleVersion
 */
export function getIvByMapleVersion(ver) {
    switch (ver) {
        case WzMapleVersion.GMS: return WZ_GMSIV;
        case WzMapleVersion.EMS: return WZ_MSEAIV;
        case WzMapleVersion.BMS:
        case WzMapleVersion.CLASSIC:
        default: return WZ_BMSIV;
    }
}

/**
 * WZ directory entry types (from WzDirectory.ParseDirectory)
 */
export const WzDirectoryType = {
    UnknownType_1: 1,
    RetrieveStringFromOffset_2: 2,
    WzDirectory_3: 3,
    WzImage_4: 4,
};
